<!DOCTYPE html>
<html>
	<style>
		#messages
		{
		background-color:yellow;
		font-size:3;
		font-weight:bold;
		line-height:140%;
		}
		#status
		{
		background-color:red;
		font-size:4;
		font-weight:bold;
		color:white;
		line-height:140%;
		}
		/* Style inputs, select elements and textareas */
		input[type=text], select, textarea, button{
		width: 100%;
		padding: 12px;
		border: 1px solid #ccc;
		border-radius: 4px;
		box-sizing: border-box;
		resize: vertical;
		}

		/* Style the label to display next to the inputs */
		label {
		padding: 12px 12px 12px 0;
		display: inline-block;
		}

		/* Style the submit button */
		input[type=submit] {
		background-color: #04AA6D;
		color: white;
		padding: 12px 20px;
		border: none;
		border-radius: 4px;
		cursor: pointer;
		float: right;
		}

		input[type=button] {
		background-color: #aa0404;
		color: white;
		padding: 12px 20px;
		border: none;
		border-radius: 4px;
		cursor: pointer;
		float: right;
		}

		/* Style the container */
		.container {
		border-radius: 5px;
		background-color: #f2f2f2;
		padding: 20px;
		}

		/* Floating column for labels: 25% width */
		.col-25 {
		float: left;
		width: 25%;
		margin-top: 6px;
		}

		/* Floating column for inputs: 75% width */
		.col-75 {
		float: left;
		width: 75%;
		margin-top: 6px;
		}

		/* Clear floats after the columns */
		.row:after {
		content: "";
		display: table;
		clear: both;
		}

		/* Responsive layout - when the screen is less than 600px wide, make the two columns stack on top of each other instead of next to each other */
		@media screen and (max-width: 600px) {
		.col-25, .col-75, input[type=submit] {
		width: 100%;
		margin-top: 0;
		}
		.col-25, .col-75, input[type=button] {
		width: 100%;
		margin-top: 0;
		}
		} 
	</style>
	
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<title>ENGO 651 MQTT Lab04</title>
		<!-- Adding leaflet -->
		<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
		integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
		crossorigin=""/>
		<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
		integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
		crossorigin=""></script>
		
		<script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.js" type="text/javascript"></script>
		<script type = "text/javascript" src = "https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>

		<link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700" rel="stylesheet">
    		<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.4.1/css/all.css" integrity="sha384-5sAR7xN1Nv6T6+dT2mhtzEpVJvfS3NScPQTrOxhwjIuvcA67KV2R5Jz6kr4abQsz" crossorigin="anonymous">
		
	</head>
	<body>
		<h1>ENGO 651 - Lab04 - Websockets Using JavaScript MQTT Client</h1>
		<script>
			var connected_flag=0	
			var mqtt;
			var reconnectTimeout = 2000;
			//var host="192.168.1.41";
			//var port=9001;
		</script>
	
		<div id="status">Connection Status: Not Connected</div>
		<br>
		<form name="connform" action="" onsubmit="return MQTTconnect()">
			<div class="col-25">
				<label for="fname">Server:</label>
			</div>
			<div class="col-75">
				<input type="text" id="servername" name="server" placeholder="Your server ..">
			</div>
			<div class="col-25">
				<label for="fname"> Port:</label>
			</div>
			<div class="col-75">
				<input type="text" id="portname" name="port" placeholder="Your port..">
			</div>
			<input type="submit" value="Connect">
			<input type="button" name="discon " value="DisConnect" onclick="disconnect()">
		</form>
		<hr>
		<form name="subs" action="" onsubmit="return sub_topics()">
			<div class="col-25">
				<label for="fname">Subscribe Topic:</label>
			</div>
			<div class="col-75">
				<input type="text" id="stopicname" name="Stopic" placeholder="Your stopic..">
			</div>
			<!-- Subscribe Topic:   <input type="text" name="Stopic"><br><br> -->
			<input type="submit" value="Subscribe">
		</form> 
		<hr>
		<form name="smessage" action="" onsubmit="return send_message()">
			<!-- Message: <input type="text" name="message"><br><br> -->
			<!-- Publish Topic:   <input type="text" name="Ptopic"><br><br> -->
			<div class="col-25">
				<label for="fname">Publish Topic:</label>
			</div>
			<div class="col-75">
				<input type="text" id="ptopicname" name="Ptopic" placeholder="Your topic..">
			</div>
			<div class="row">
				<div class="col-25">
				  <label for="subject">Message:</label>
				</div>
				<div class="col-75">
				  <textarea id="subject" name="message" placeholder="Write something.." style="height:200px"></textarea>
				</div>
			  </div>
			<input type="submit" value="Submit">
		</form>
		<br>
	</br>
		<hr>
		Messages:<p id="messages"></p>
		<hr>
		<button id = "find-me">Share my status</button><br/>
		<p id = "loc-status"></p>
		<div class="container">
		<!-- <div id="map" style="width: 100%;height:100%;"></div> -->
		<span style="width:298px; height: 298px;"><div id="map" style="height: 200px;"></div></span>
		</div>
	</body>
<script type = "text/javascript">

		function onConnectionLost(){
			console.log("connection lost");
			document.getElementById("status").innerHTML = "Connection Lost";
			document.getElementById("messages").innerHTML ="Connection Lost";
			connected_flag=0;
			if(disconnected_flag == 0){
				document.getElementById("messages").innerHTML = "Connection Lost- Retrying";
				setTimeout(MQTTconnect, reconnectTimeout);
			}
		}

		function onFailure(message) {
			console.log("Failed");
			document.getElementById("messages").innerHTML = "Connection Failed- Retrying";
			setTimeout(MQTTconnect, reconnectTimeout);
		}

		function onMessageArrived(r_message){
			out_msg = "Message received: " + r_message.payloadString;
			var blueMarker = {
				radius: 8,
				fillColor: "#0000ff",
				color: "#000",
				weight: 1,
				opacity: 1,
				fillOpacity: 0.9
				};
			var redMarker = {
				radius: 8,
				fillColor: "#ff0000",
				color: "#000",
				weight: 1,
				opacity: 1,
				fillOpacity: 0.9
				}
			var greenMarker = {
				radius: 8,
				fillColor: "#00ff2a",
				color: "#000",
				weight: 1,
				opacity: 1,
				fillOpacity: 0.9
				}
			function onEachFeature(feature, layer) {
				// does this feature have a property named popupContent?
				if (feature.properties && feature.properties.popupContent) {
					layer.bindPopup(feature.properties.popupContent);
				}
			}
			if(r_message.payloadString.substr(0,9) == '{"name":"'){
            	obj = JSON.parse(r_message.payloadString);
            	if(obj['name'] != null && obj['name'] == "NewFeatureType"){
					latitude = obj.features[0].geometry.coordinates[0]
					longitude = obj.features[0].geometry.coordinates[1]
					map.setView([longitude, latitude], 14);					
					L.geoJSON(obj, {
						pointToLayer: function (feature, latlng) {
							if(feature.properties.temp < 60 && feature.properties.temp >= 30){
								return L.circleMarker(latlng, redMarker)
							} else if(feature.properties.temp < 30 && feature.properties.temp >= 10) {
								return L.circleMarker(latlng, greenMarker)	
							} else {
								return L.circleMarker(latlng, blueMarker)	
							}
						},
						onEachFeature: onEachFeature
					}).addTo(map); 	
            	}
        	}else{
                document.getElementById("messages").innerHTML = out_msg;
        	}
		}

		function onConnected(recon,url){
			console.log(" in onConnected " + reconn);
		}

		function onConnect() {
			// Once a connection has been made, make a subscription and send a message.
			document.getElementById("messages").innerHTML = "Connected to " + host + "on port " + port;
			connected_flag = 1
			document.getElementById("status").innerHTML = "Connected";
			console.log("on Connect "+connected_flag);
			//mqtt.subscribe("sensor1");
			//message = new Paho.MQTT.Message("Hello World");
			//message.destinationName = "sensor1";
			//mqtt.send(message);
		}

		function disconnect(){
			disconnected_flag = 1;
			if (connected_flag == 1)
				mqtt.disconnect();
				document.getElementById('servername').disabled = false;
				document.getElementById('portname').disabled = false;
		}

		function MQTTconnect() {
			disconnected_flag = 0;
			document.getElementById('servername').disabled = true;
			document.getElementById('portname').disabled = true;

			document.getElementById("messages").innerHTML ="";
			var s = document.forms["connform"]["server"].value;
			var p = document.forms["connform"]["port"].value;
			if (p!=""){
				console.log("ports");
				port=parseInt(p);
				console.log("port" +port);
			}
			if (s!=""){
				host=s;
				console.log("host");
			}
			console.log("connecting to "+ host +" "+ port);
			var x=Math.floor(Math.random() * 10000); 
			var cname="orderform-"+x;
			mqtt = new Paho.MQTT.Client(host,port,cname);
			var options = {
				timeout: 30,
				onSuccess: onConnect,
				onFailure: onFailure,
			};		
			mqtt.onConnectionLost = onConnectionLost;
			mqtt.onMessageArrived = onMessageArrived;
			mqtt.onConnected = onConnected;
			mqtt.connect(options);
			return false;
		}

		function sub_topics(){
			document.getElementById("messages").innerHTML ="";
			if (connected_flag==0){
				out_msg="<b>Not Connected so can't subscribe</b>"
				console.log(out_msg);
				document.getElementById("messages").innerHTML = out_msg;
				return false;
				}
			var stopic= document.forms["subs"]["Stopic"].value;
			console.log("Subscribing to topic =" + stopic);
			mqtt.subscribe(stopic);
			return false;
		}

		function send_message(){
			document.getElementById("messages").innerHTML ="";
			if (connected_flag==0){
				out_msg="<b>Not Connected so can't send</b>"
				console.log(out_msg);
				document.getElementById("messages").innerHTML = out_msg;
				return false;
			}
			var msg = document.forms["smessage"]["message"].value;
			console.log(msg);
			var topic = document.forms["smessage"]["Ptopic"].value;
			message = new Paho.MQTT.Message(msg);
			if (topic=="")
				message.destinationName = "ENGO_651/reza/my_temperature"
			else
				message.destinationName = topic;
			mqtt.send(message);
			return false;
		}

		var map = L.map('map').setView([35.698, 51.4114], 12);
		var streets_v11 = L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token={accessToken}', {
				attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
				maxZoom: 22,
				id: 'mapbox/streets-v11',
				tileSize: 512,
				zoomOffset: -1,
				accessToken: 'pk.eyJ1IjoicnNhZmFyemFkZWgiLCJhIjoiY2tsNjloYnRtMmczbDJubXM0bHE3OHUwbSJ9.fyRBTHuhQ0tzr2mS1CbfIw'
			}).addTo(map);

		const status = document.querySelector('#loc-status');
		function geoFindMe() {

			function success(position) {
				status.textContent = '';
				var random_temp = Math.floor(Math.random() * 101) - 40
				var latitude  = position.coords.latitude;
				var longitude = position.coords.longitude;

				if (connected_flag==0){
					out_msg="<b>Not Connected so can't send location</b>"
					console.log(out_msg);
					document.getElementById("loc-status").innerHTML = out_msg;
					return false;
				}

				var geojson = {
					"name":"NewFeatureType",
					"type":"FeatureCollection",
					"features":[
						{
						"type":"Feature",
						"geometry":{
							"type":"Point",
							"coordinates":[longitude, latitude]
						},
						"properties":{
							"popupContent":"Temp : "+ random_temp,
							"temp": random_temp
						}
						}
					]
				};

				var msg = document.forms["smessage"]["message"].value;
				var topic = document.forms["smessage"]["Ptopic"].value;
				txt_01 = JSON.stringify(geojson)
				message = new Paho.MQTT.Message(txt_01);
				if (topic=="")
					message.destinationName = "ENGO_651/reza/my_temperature"
				else
					message.destinationName = topic;
				mqtt.send(message);
			}

			function error() {
				status.textContent = 'Unable to retrieve your location';
			}

			if(!navigator.geolocation) {
				status.textContent = 'Geolocation is not supported by your browser';
			} else {
				status.textContent = 'Locating…';
				navigator.geolocation.getCurrentPosition(success, error);
			}
		}
		document.querySelector('#find-me').addEventListener('click', geoFindMe);

	</script>
</html>
